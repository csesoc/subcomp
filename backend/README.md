# Backend

The backend server is written in Rust using the [Rocket](https://rocket.rs/) web framework and [Diesel](https://diesel.rs/) object relational mapping (ORM) and query builder.

The database uses [PostgreSQL](https://www.postgresql.org/). Although fancy features aren't used, it has only been tested with PostgreSQL 14.4.

Be a good person and run `cargo clippy --fix` every so often.


## Documentation

If you are new to Rust, take a look at the [Rust Book](https://doc.rust-lang.org/book/).

[See Rocket documentation.](https://rocket.rs/v0.5-rc/guide//)

[See Diesel documentation here.](https://diesel.rs/guides/)

[See PostgreSQL 14 documentation here.](https://www.postgresql.org/docs/14/index.html)


## Architecture

`src/main.rs` launches the backend server, including connecting to the database. If you add another endpoint, you will need to mount it here.

`src/api.rs` implements all API endpoints for the backend server, including defining the API parameters, request bodies, and response bodies. If you add another endpoint, you will need to implement it here.

`src/responses.rs` defines helper methods to return API responses. It is unlikely you will need to modify this file.

`src/handlers.rs` defines catchers to handle 4xx and 5xx errors. It is unlikely you will need to modify this file.

`src/models.rs` defines the database schema in the database and implements methods to select, insert, update, and delete from the database. This is where you would modify the database schema and add functions to query the database.

`src/schema.rs` is generated by Diesel based on `src/models.rs`. Do not modify this file.

`src/database.rs` implements the pool manager to the database. It is unlikely you will need to modify this file.


## Environment variables

A `.env` file must exist in this directory. It must contain:

- `DATABASE_URL` = A [connection URI](https://www.postgresql.org/docs/current/libpq-connect.html#LIBPQ-CONNSTRING) used by Diesel to find the database.
- `PASSWORD_SALT` = [A random string used as an input when generating password bashes.](https://en.wikipedia.org/wiki/Salt_(cryptography)) Please use a long and complex string.
- `DOMAIN` = The domain name used to host the frontend. When developing locally, this will be localhost with some port. When deploying, please use [HTTPS](https://en.wikipedia.org/wiki/HTTPS).
- `SMTP_USERNAME` = An email address using [SMTP](https://en.wikipedia.org/wiki/Simple_Mail_Transfer_Protocol) under your control to send verification and password reset emails to user.
- `SMTP_PASSWORD` = The password to the above email address.
- `PROJECT_END` = A [RFC 3339](https://www.rfc-editor.org/rfc/rfc3339.txt) timestamp of when project submission ends.
- `VOTE_END` = A [RFC 3339](https://www.rfc-editor.org/rfc/rfc3339.txt) timestamp of when voting ends.

An example `.env` would look like:

```
DATABASE_URL=postgres://postgres:postgres@localhost/subcomp
PASSWORD_SALT=VERY_LONG_AND_COMPLEX_STRING
DOMAIN=http://localhost:3000
SMTP_USERNAME=noreply@example.com
SMTP_PASSWORD=password
PROJECT_END=1999-09-09T23:59:59+10:00
VOTE_END=1999-09-19T23:59:59+10:00
```
